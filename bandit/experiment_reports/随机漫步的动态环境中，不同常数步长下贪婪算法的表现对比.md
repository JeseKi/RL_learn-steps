# 随机漫步的动态环境中，不同常数步长下贪婪算法的表现对比

# 实验条件

* 环境：多臂老虎机（动态环境）
* 臂数 ($K$): 10
* 步数 ($T$): $10^5$
* 每个臂的的奖励分布：$X\sim\text{Bernoulli}(\theta_i)\\ \text{其中，}\theta_i=\frac{i}{K+1}\ ,(i\in\{1,2,3...,K\})$
* 环境随机漫步表达式：$r_i^{(t+1)} =  \begin{cases} r_i^{(t)} + \varepsilon_i & if \ 0 \leq r_i^{(t)}+\varepsilon_i\leq1 \\ r_i^{(t)} - \varepsilon_i & otherwise \end{cases}$

  其中：

  * $r_i^{(t)}$表示在第 $i$ 个机器在 $t$ 时刻的奖励概率。
  * $\epsilon_i\sim\mathcal{N}(0,0.01^2)$ 是从正态分布采样的随机扰动。
  * 随机漫步间隔：1
  * 每次随机漫步影响的机器数量：10
* 算法：$Greedy$  

  * 表达式：$a_{t+1} = \arg\max_{a\in \{1,2,3,...,A\}}\hat{Q}_t(a)\\ \text{其中，}\hat{Q}_t(a)= \begin{cases} Q_0 &\text{如果动作 a 还没有被选择过}\\ \hat{Q}_{t-1}(a)+\alpha\cdot(R_{t}-\hat{Q}_{t-1}(a)) & \text{如果动作 a 已经被选择过} \\ \hat{Q}_{t-1}(a) +\frac{1}{N_{t}(a)}\cdot(R_t-\hat{Q}_{t-1}(a)) & \text{Baseline Greedy} \end{cases}$
  * $Q_0 = 1$
  * 参数：

    * $\hat{Q}_t(a)\text{: 对动作 a 在 t 时刻的回报真实值估量}$
    * $\alpha:常数步长值（以下统称“学习率”）$
    * $A\text{: 动作空间}$
    * $R_t\text{: t 时刻的奖励}$
    * $Q_0\text{: 乐观初始化值}$
  * 基线：样本均值更新方式的 $Greedy$，带乐观初始化
* 重复运行次数($R$)：500

  * 说明：同一次重复运行中，每个 Agent 的种子均不同，不同重复运行的 Agent 种子均相同。所有重复运行的环境种子均相同。
* 实验目的：比较不同 $\alpha$ 下贪心算法的性能
* 指标

  * 后悔率（以“动态最优”为基准（即每步对比当时刻最优臂））
  * 后悔值（以“动态最优”为基准（即每步对比当时刻最优臂））
  * 奖励率
  * 奖励值
  * 最佳臂命中率
  * 滑动窗口奖励率

# 实验记录

## 聚合图表

|X-线性增长|X-指数增长|
| --------------------------------------------------------------------------------------------------------------------| --------------------------------------------------------------------------------------------------------|
|<br />![](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/b7a6a42430c7429c94603c514637de0c_x_log_False.png)|​​![](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/b7a6a42430c7429c94603c514637de0c.png)|
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>学习率实验结果</title>
  <style>
    body {
      font-family: "Microsoft YaHei", sans-serif;
      padding: 20px;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      overflow-x: auto;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      text-align: center;
      border: 1px solid #ddd;
    }
    th {
      background-color: #eee;
      font-weight: bold;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tr:hover {
      background-color: #ffe0b2;
      transition: background 0.2s ease;
    }
    /* 颜色标记 */
    .best { background-color: #c8e6c9 !important; }        /* 绿色 - 最优 */
    .worst { background-color: #ffcdd2 !important; }       /* 红色 - 最差 */
    .baseline { background-color: #fff9c4 !important; }     /* 黄色 - baseline */
    .best td, .worst td, .baseline td {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>学习率实验结果表</h1>
  <div class="container">
    <table>
      <thead>
        <tr>
          <th>学习率/基线</th>
          <th>遗憾率</th>
          <th>遗憾值</th>
          <th>奖励率</th>
          <th>奖励值</th>
          <th>滑动窗口奖励率</th>
          <th>最优臂率</th>
        </tr>
      </thead>
      <tbody>
        <tr class="baseline"><td>baseline</td><td>0.3294</td><td>30257.93</td><td>0.6063</td><td>60631.4</td><td>0.5110</td><td>0.1896</td></tr>
        <tr><td>0.001</td><td>0.2827</td><td>26029.13</td><td>0.6486</td><td>64860.2</td><td>0.6648</td><td>0.2265</td></tr>
        <tr><td>0.005</td><td>0.2428</td><td>22494.73</td><td>0.6839</td><td>68394.6</td><td>0.6790</td><td>0.3390</td></tr>
        <tr class="best"><td>0.01</td><td>0.2365</td><td>21918.53</td><td>0.6897</td><td>68970.8</td><td>0.6796</td><td>0.3805</td></tr>
        <tr class="best"><td>0.05</td><td>0.2317</td><td>21471.13</td><td>0.6942</td><td>69418.2</td><td>0.6796</td><td>0.4183</td></tr>
        <tr><td>0.1</td><td>0.2359</td><td>21857.93</td><td>0.6903</td><td>69031.4</td><td>0.6740</td><td>0.4013</td></tr>
        <tr><td>0.3</td><td>0.2551</td><td>23583.73</td><td>0.6731</td><td>67305.6</td><td>0.6648</td><td>0.3323</td></tr>
        <tr><td>0.5</td><td>0.2730</td><td>25188.13</td><td>0.6570</td><td>65701.2</td><td>0.6486</td><td>0.2972</td></tr>
        <tr><td>0.7</td><td>0.2734</td><td>25221.73</td><td>0.6567</td><td>65667.6</td><td>0.6478</td><td>0.2979</td></tr>
        <tr><td>0.9</td><td>0.2735</td><td>25234.13</td><td>0.6566</td><td>65655.2</td><td>0.6560</td><td>0.2965</td></tr>
        <tr><td>0.99</td><td>0.2733</td><td>25220.73</td><td>0.6567</td><td>65668.6</td><td>0.6536</td><td>0.2960</td></tr>
        <tr><td>0.999</td><td>0.2747</td><td>25345.53</td><td>0.6554</td><td>65543.8</td><td>0.6488</td><td>0.2903</td></tr>
        <tr><td>0.9999</td><td>0.2759</td><td>25447.53</td><td>0.6544</td><td>65441.8</td><td>0.6518</td><td>0.2885</td></tr>
        <tr class="worst"><td>0.99999</td><td>0.2776</td><td>25607.13</td><td>0.6528</td><td>65282.2</td><td>0.6496</td><td>0.2823</td></tr>
      </tbody>
    </table>
  </div>
  <p style="text-align:center; margin-top:20px; font-size:14px; color:#777;">
    数据标记说明：<br>
    🟡 <strong>黄色</strong> = baseline<br>
    🟢 <strong>绿色</strong> = 最优（最优臂率最高）→ 0.01 & 0.05<br>
    🔴 <strong>红色</strong> = 最差（遗憾值最高）→ baseline & 0.99999<br>
  </p>
</body>

## 单独图表

* 基线：

  ![](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/baseLine_GreedyAgent_20251008_140527.jpeg)
* 各学习率下 $Greedy$ 的表现

  |学习率|算法表现|
  | ---------| ------------------------------------------------------------------------------------------------------------------------------|
  |0.001|​​![0.001](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/learn_rate_0.001_GreedyAgent_20251008_134105.jpeg)|
  |0.005|​​![0.005](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/learn_rate_0.005_GreedyAgent_20251008_134233.jpeg)|
  |0.01|​​![0.01](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/learn_rate_0.01_GreedyAgent_20251008_134535.jpeg)|
  |0.05|​​![0.05](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/learn_rate_0.05_GreedyAgent_20251008_134701.jpeg)|
  |0.1|​​![0.1](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/learn_rate_0.1_GreedyAgent_20251008_135015.jpeg)|
  |0.3|​​![0.3](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/learn_rate_0.3_GreedyAgent_20251008_135340.jpeg)|
  |0.5|​​![0.5](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/learn_rate_0.5_GreedyAgent_20251008_135508.jpeg)|
  |0.7|​​![0.7](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/learn_rate_0.7_GreedyAgent_20251008_135636.jpeg)|
  |0.9|​​![0.9](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/learn_rate_0.9_GreedyAgent_20251008_135803.jpeg)|
  |0.99|​​![0.99](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/learn_rate_0.99_GreedyAgent_20251008_135931.jpeg)|
  |0.999|​​![0.999](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/learn_rate_0.999_GreedyAgent_20251008_140101.jpeg)|
  |0.9999|​​![0.9999](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/learn_rate_0.9999_GreedyAgent_20251008_140229.jpeg)|
  |0.99999|​​![0.99999](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/learn_rate_0.99999_GreedyAgent_20251008_140400.jpeg)|

# 实验现象

通过对 $Greedy$ 算法在 $10^5$ 内不同学习率($\alpha$)下的各项指标进行观察和对比，我们发现了如下实验现象：

1. **总体性能：**  **$\alpha=0.05$** **时** **$Greedy$** **表现最优，Baseline 的表现差于学习率为任何值下的** **$Greedy$**​ **。**

从最终的后悔率、后悔值、奖励率、奖励值、最优臂命中率和滑动窗口奖励率等多个核心指标来看，各个学习率下的  表现均优于样本均值下的 $Greedy$。

在 Baseline 下，由于在动态环境中，早期的经验往往是有效的，而过往的经验往往成为负担，因此出现了基线的各项指标在早期虽然较为领先，但是导致后期就急速下降的现象。

而对于恰当的学习率，即 $\alpha=0.05$ 时，由于算法可以及时的忘掉早期已经失效的经验，并保留足够短期内有效的经验，因此虽然在早期的性能表现不如 Baseline，但是在中期便进行了反超，且性能一直保持稳定，波动并不明显。

2. **最佳臂命中率、后悔率、奖励率和滑动窗口奖励率分析**

最佳臂命中率是衡量算法能否在环境变化后准确找到并持续选择最优动作的关键指标。

在 Baseline 下，最佳臂命中率在 $t=611$ 左右时便达到了最高点，之后持续下滑；后悔率在 $t=1112$ 左右时便达到了最低点，后续则波动性的上涨；奖励率则是在$t=1891$ 左右便达到了最高点，后续持续下滑；最后是滑动窗口奖励率，在$t=1192$左右时达到最高点，后续也持续下降。 

![](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/202510121245673.png)

![](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/202510121246618.png)​​![](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/202510121245473.png)

![](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/202510121248603.png)

对于 $\alpha=0.05$ 的 $Greedy$，则是各项指标在 $t=2000$ 左右时，便达到了最高点，且基本不再发生大的波动，一直保持一个比较平稳的曲线。

![](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/202510121314484.png)

而当 $\alpha \neq0.05$ 时，不论学习率是上调还是下调，可以看出性能都会下降，**因此可以认为当前的动态环境中**，$\alpha^*\approx0.05$​。

当 $\alpha\ll0.05$，如当 $\alpha\le0.005$ 时，Agent 的学习速度过慢，导致在前中期的表现反而一直不如 Baseline，在后期才逐渐超越。

![](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/202510121334472.png)

而当$\alpha\gg0.05$时，如当 $\alpha\ge0.5$时，虽然 Agent 避免了因记住早期过时经验导致的受到过去经验的制约，但也因为记忆过短导致无法记住近期的有用信息，所以可以看到$\alpha\ge0.5$时的曲线几乎重合在一起，并且早早的便陷入了相对来说更次的次优解。

![](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/202510121342298.png)

![](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/202510121337521.png)

3. **总体分析**

总的来说，在样本均值的 Q 值更新方法下，$Greedy$ 在 $t\in(500, 1500)$时，可以保持一定的优势，但在 $t>1500$ 后，Baseline 的表现便被学习率为 0.05 时的 $Greedy$ 所反超。

![](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/202510121255707.png)

![](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/202510121255485.png)

以及，当学习率在一定程度内时， Agent 可以因遗忘了早期失效的经验而不受到早期失效经验的影响的同时，保留近期有效的经验，进而达到在动态环境中保持性能稳定的效果。如果学习率设置的太小，Agent 会因为无法及时的忘掉过去的经验导致性能提升速度极慢；但如果设置的太高，又会因为近期保留的经验过少而无法进一步的提升性能。

![](https://tuchuang-1317479375.cos.ap-beijing.myqcloud.com/202510121403870.png)

# 实验结论

本次实验系统性的比较了贪婪算法的 Q 值在不同的更新方法下，在动态多臂老虎机上的性能。实验结论如下：

1. **核心结论：常数步长更新比样本均值更新更合适在动态环境中使用。在常数步长值合适时，它可以在“遗忘”与“学习”中取得在前中期以后最高的效率。** 样本均值更新因无法遗忘过时的经验而被过时经验在前中期后严重拖累性能，常数步长更新所设置的值过低会因为遗忘速度过慢而遇到和样本均值更新类似的问题——被过时经验严重拖累性能；所设置的值过高又会因为遗忘速度过快，无法记住近期有效的经验而无法进一步提升性能；只有当常数步长值合适时，才能取得在“遗忘”和“学习”中最佳的效率。
2. **更新方式的策略分析：**

    * 样本均值更新：该更新方式将认为所有的的经验都是同等重要的，其更新方式是取所有经验的均值来决定一个臂的 Q 值，这在动态环境中无法遗忘过时经验，进而导致性能下降
    * 常数步长更新：该更新方式可以在“遗忘”和“学习”间进行手动设置来决定平衡，这可以在动态环境中遗忘过时经验，来保证性能的平稳。
3. **总结和启示：** 该实验结果表明，在动态多臂老虎机问题中，**算法的 Q 值更新方法对“遗忘”和“学习”的取舍是决定其性能的关键**。**$\alpha\approx0.05$**时的常数步长更新方法，能够在当前的动态环境中很好的平衡“遗忘”和“学习”两种机制，从而在整体性能上超越样本均值更新与$\alpha\gg0.05$或$\alpha\ll0.05$时的常数步长更新方法。

# 附录

实验 [notebook](https://github.com/JeseKi/RL_learn-steps/blob/main/bandit/notebooks/constant_step_vs_sample_mean.ipynb)

实验[仓库](https://github.com/JeseKi/RL_learn-steps)